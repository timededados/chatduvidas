<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Dicionário de Consulta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #1e1e2f;
      --fg: #f5f5f5;
      --primary: #4f8cff;
      --secondary: #2e2e42;
      --border: #3a3a52;
      --input-bg: #2b2b3f;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: "Inter", "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 2em;
    }
    
    h2 {
      color: var(--primary);
      margin-top: 40px;
      margin-bottom: 20px;
      font-size: 1.5em;
    }
    
    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
    }
    
    .link-btn {
      background: var(--primary);
      color: #fff;
      padding: 10px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .link-btn:hover {
      background: #3573f7;
      transform: translateY(-1px);
    }
    
    form {
      background: var(--secondary);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    
    label {
      display: block;
      margin-bottom: 16px;
      font-weight: 500;
      color: var(--fg);
    }
    
    label span.label-text {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    input[type="text"],
    input[type="url"],
    select {
      width: 100%;
      padding: 12px 16px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--fg);
      font-size: 15px;
      transition: all 0.2s;
    }
    
    select[multiple] {
      height: 120px;
    }
    
    input[type="text"]:focus,
    input[type="url"]:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.1);
    }
    
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .radio-group {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      cursor: pointer;
      font-weight: normal;
    }
    
    input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #saveBtn {
      background: var(--success);
      color: white;
    }
    
    #saveBtn:hover {
      background: #0ea672;
      transform: translateY(-1px);
    }
    
    #resetBtn {
      background: var(--border);
      color: var(--fg);
    }
    
    #resetBtn:hover {
      background: #4a4a62;
    }
    
    .table-container {
      background: var(--secondary);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: var(--input-bg);
    }
    
    th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
    }
    
    td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    
    tbody tr {
      transition: background 0.2s;
    }
    
    tbody tr:hover {
      background: rgba(79, 140, 255, 0.05);
    }
    
    .actions button {
      padding: 6px 14px;
      font-size: 13px;
      margin-right: 6px;
    }
    
    .actions button[data-act="edit"] {
      background: var(--primary);
      color: white;
    }
    
    .actions button[data-act="edit"]:hover {
      background: #3573f7;
    }
    
    .actions button[data-act="del"] {
      background: var(--danger);
      color: white;
    }
    
    .actions button[data-act="del"]:hover {
      background: #dc2626;
    }
    
    .muted {
      color: #9ca3af;
      font-size: 14px;
      margin-top: 8px;
      min-height: 20px;
    }
    
    .muted.error {
      color: var(--danger);
    }
    
    a {
      color: var(--primary);
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .tag {
      display: inline-block;
      background: rgba(79, 140, 255, 0.2);
      color: var(--primary);
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    
    .tags-container {
      position: relative;
    }
    
    .tags-input-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 46px;
      cursor: text;
      transition: all 0.2s;
    }
    
    .tags-input-wrapper:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.1);
    }
    
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 13px;
    }
    
    .tag-chip button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .tag-chip button:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .tags-search {
      flex: 1;
      min-width: 200px;
      background: transparent;
      border: none;
      outline: none;
      color: var(--fg);
      font-size: 14px;
      padding: 4px;
    }
    
    .tags-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .tags-dropdown-item {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .tags-dropdown-item:hover {
      background: rgba(79, 140, 255, 0.1);
    }
    
    .tags-dropdown-item.selected {
      background: rgba(79, 140, 255, 0.2);
      color: var(--primary);
    }
    
    .tags-dropdown-empty {
      padding: 10px 14px;
      color: #9ca3af;
      text-align: center;
    }
    
    .upload-container {
      margin-top: 16px;
      display: none;
    }
    
    .upload-container.visible {
      display: block;
    }
    
    .upload-preview {
      margin-top: 12px;
      max-width: 200px;
      border-radius: 8px;
      border: 2px solid var(--border);
    }
    
    .upload-label {
      display: inline-block;
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .upload-label:hover {
      background: #3573f7;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .upload-status {
      margin-top: 8px;
      font-size: 13px;
      color: #9ca3af;
    }
    
    .remove-image {
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .remove-image:hover {
      background: #dc2626;
    }
    
    @media (max-width: 768px) {
      .row {
        grid-template-columns: 1fr;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 10px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📚 Dicionário de Consulta</h1>
    
    <div class="top-actions">
      <a class="link-btn" href="/">💬 Voltar ao Chat</a>
    </div>

    <form id="dictForm">
      <input type="hidden" id="entryId" />
      <input type="hidden" id="imagemUrl" />
      
      <label>
        <span class="label-text">Título (obrigatório)</span>
        <input type="text" id="titulo" required placeholder="Digite o título..." />
      </label>
      
      <div class="row">
        <label>
          <span class="label-text">Autor</span>
          <input type="text" id="autor" placeholder="Nome do autor..." />
        </label>
        <label>
          <span class="label-text">Tipo de conteúdo</span>
          <select id="tipoConteudo">
            <option value="">Selecione...</option>
            <option value="Preparatório TEME">Preparatório TEME</option>
            <option value="PodTEME">PodTEME</option>
            <option value="Instagram Post">Instagram Post</option>
            <option value="Blog Post">Blog Post</option>
            <option value="Cursos Online">Cursos Online</option>
          </select>
        </label>
      </div>
      
      <div class="row">
        <label>
          <span class="label-text">Pago?</span>
          <div class="radio-group">
            <label><input type="radio" name="pago" value="nao" checked /> Não</label>
            <label><input type="radio" name="pago" value="sim" /> Sim</label>
          </div>
          
          <!-- Campo de upload de imagem (aparece quando Pago = Sim) -->
          <div class="upload-container" id="uploadContainer">
            <label class="upload-label">
              📷 Escolher Imagem
              <input type="file" id="imagemFile" accept="image/*" />
            </label>
            <div class="upload-status" id="uploadStatus"></div>
            <img id="imagemPreview" class="upload-preview" style="display: none;" />
            <button type="button" class="remove-image" id="removeImageBtn" style="display: none;">
              🗑️ Remover Imagem
            </button>
          </div>
        </label>
        <label>
          <span class="label-text">Link</span>
          <input type="url" id="link" placeholder="https://..." />
        </label>
      </div>
      
      <label>
        <span class="label-text">Tags (categorias do sumário)</span>
        <div class="tags-container">
          <div class="tags-input-wrapper" id="tagsInputWrapper">
            <input 
              type="text" 
              class="tags-search" 
              id="tagsSearch" 
              placeholder="Buscar e adicionar categorias..."
              autocomplete="off"
            />
          </div>
          <div class="tags-dropdown" id="tagsDropdown" style="display: none;"></div>
        </div>
        <small style="color: #9ca3af; margin-top: 4px; display: block;">
          Digite para buscar e clique para adicionar categorias
        </small>
      </label>
      
      <div class="form-actions">
        <button type="submit" id="saveBtn">💾 Salvar</button>
        <button type="button" id="resetBtn">🔄 Limpar</button>
      </div>
      
      <div id="msg" class="muted"></div>
    </form>

    <h2>Itens cadastrados</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Título</th>
            <th>Autor</th>
            <th>Tipo</th>
            <th>Pago</th>
            <th>Imagem</th>
            <th>Link</th>
            <th>Tags</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Carregar categorias do sumário
    let categorias = [];
    let selectedTags = [];
    
    async function loadCategorias() {
      try {
        const res = await fetch("/api/categorias");
        const data = await res.json();
        
        if (data.categorias && Array.isArray(data.categorias)) {
          categorias = data.categorias;
          console.log("Categorias carregadas:", categorias.length);
        } else {
          console.error("Formato de resposta inválido:", data);
        }
      } catch (e) {
        console.error("Erro ao carregar categorias:", e);
      }
    }

    // Sistema de tags com busca
    const tagsSearch = $("#tagsSearch");
    const tagsInputWrapper = $("#tagsInputWrapper");
    const tagsDropdown = $("#tagsDropdown");

    // Helper: adiciona tag e re-renderiza (ignora duplicadas)
    function addTag(tag) {
      if (!tag) return;
      if (!selectedTags.includes(tag)) {
        selectedTags.push(tag);
        renderSelectedTags();
      }
      tagsSearch.value = "";
      tagsDropdown.style.display = "none";
      tagsSearch.focus();
    }

    // Delegação: usar pointerdown para capturar antes do blur/propagação
    tagsDropdown.addEventListener("pointerdown", (e) => {
      const item = e.target.closest(".tags-dropdown-item");
      if (!item) return;
      e.preventDefault();
      e.stopPropagation();
      addTag(item.dataset.tag);
    });

    // Fallback para navegadores sem pointer events (opcional)
    tagsDropdown.addEventListener("mousedown", (e) => {
      const item = e.target.closest(".tags-dropdown-item");
      if (!item) return;
      e.preventDefault();
      e.stopPropagation();
      addTag(item.dataset.tag);
    });

    function renderSelectedTags() {
      // Remover apenas chips dentro do wrapper (não no documento todo)
      tagsInputWrapper.querySelectorAll(".tag-chip").forEach(chip => chip.remove());

      // Inserir novos chips antes do input usando um fragment
      const frag = document.createDocumentFragment();
      selectedTags.forEach(tag => {
        const chip = document.createElement("div");
        chip.className = "tag-chip";
        const textNode = document.createTextNode(tag);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.dataset.tag = tag;
        btn.textContent = "×";
        chip.appendChild(textNode);
        chip.appendChild(btn);
        frag.appendChild(chip);
      });

      if (tagsInputWrapper.contains(tagsSearch)) {
        tagsInputWrapper.insertBefore(frag, tagsSearch);
      } else {
        tagsInputWrapper.appendChild(frag);
      }
    }

    // Delegação para remover chip sem duplicidade de eventos
    tagsInputWrapper.addEventListener("pointerdown", (e) => {
      const btn = e.target.closest(".tag-chip button");
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const tag = btn.dataset.tag;
      selectedTags = selectedTags.filter(t => t !== tag);
      renderSelectedTags();
    });

    function filterAndShowDropdown(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const filtered = categorias.filter(cat =>
        cat.toLowerCase().includes(term) && !selectedTags.includes(cat)
      );

      if (!term || filtered.length === 0) {
        tagsDropdown.style.display = "none";
        if (term && filtered.length === 0) {
          tagsDropdown.innerHTML = '<div class="tags-dropdown-empty">Nenhuma categoria encontrada</div>';
          tagsDropdown.style.display = "block";
        }
        return;
      }

      // Renderizar dropdown
      tagsDropdown.innerHTML = "";
      filtered.slice(0, 10).forEach(cat => {
        const item = document.createElement("div");
        item.className = "tags-dropdown-item";
        item.dataset.tag = cat;
        item.textContent = cat;
        tagsDropdown.appendChild(item);
      });

      tagsDropdown.style.display = "block";
    }

    tagsSearch.addEventListener("input", (e) => {
      filterAndShowDropdown(e.target.value);
    });

    // Teclado: Enter/Tab adiciona o primeiro item listado; Backspace remove última tag se input vazio
    tagsSearch.addEventListener("keydown", (e) => {
      if ((e.key === "Enter" || e.key === "Tab") && tagsDropdown.style.display !== "none") {
        const first = tagsDropdown.querySelector(".tags-dropdown-item");
        if (first) {
          e.preventDefault();
          addTag(first.dataset.tag);
        }
      } else if (e.key === "Backspace" && !tagsSearch.value && selectedTags.length) {
        // UX: remover última tag se input está vazio
        selectedTags.pop();
        renderSelectedTags();
      }
    });

    tagsSearch.addEventListener("focus", (e) => {
      if (e.target.value) {
        filterAndShowDropdown(e.target.value);
      }
    });

    // Fechar dropdown ao clicar fora
    document.addEventListener("click", (e) => {
      if (!tagsInputWrapper.contains(e.target) && !tagsDropdown.contains(e.target)) {
        tagsDropdown.style.display = "none";
      }
    });

    // Permitir clicar no wrapper para focar no input
    tagsInputWrapper.addEventListener("click", (e) => {
      if (e.target === tagsInputWrapper) {
        tagsSearch.focus();
      }
    });

    function setMsg(text, isError=false) {
      const el = $("#msg");
      el.textContent = text || "";
      el.className = isError ? "muted error" : "muted";
    }

    function formToPayload() {
      const titulo = $("#titulo").value.trim();
      const autor = $("#autor").value.trim();
      const tipoConteudo = $("#tipoConteudo").value.trim();
      const pagoVal = $$("input[name='pago']:checked")[0]?.value || "nao";
      const pago = pagoVal === "sim";
      const link = $("#link").value.trim();
      const imagemUrl = imagemUrlInput.value.trim();
      return { titulo, autor, tipoConteudo, pago, link, imagemUrl, tags: [...selectedTags] };
    }

    function payloadToForm(d) {
      $("#titulo").value = d.titulo || "";
      $("#autor").value = d.autor || "";
      $("#tipoConteudo").value = d.tipoConteudo || "";
      const pagoVal = d.pago ? "sim" : "nao";
      $$("input[name='pago']").forEach(r => r.checked = (r.value === pagoVal));
      $("#link").value = d.link || "";
      
      // Controlar visibilidade do upload e preview da imagem
      if (d.pago) {
        uploadContainer.classList.add("visible");
        if (d.imagemUrl) {
          imagemUrlInput.value = d.imagemUrl;
          imagemPreview.src = d.imagemUrl;
          imagemPreview.style.display = "block";
          removeImageBtn.style.display = "inline-block";
          uploadStatus.textContent = "✅ Imagem carregada";
          uploadStatus.style.color = "var(--success)";
        }
      } else {
        uploadContainer.classList.remove("visible");
        clearImageUpload();
      }
      
      selectedTags = Array.isArray(d.tags) ? [...new Set(d.tags)] : [];
      renderSelectedTags();
    }

    async function loadList() {
      const res = await fetch("/api/dict");
      const data = await res.json();
      renderList(data);
    }

    function renderList(items) {
      const body = $("#listBody");
      body.innerHTML = "";
      if (!items.length) {
        body.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:24px;">Nenhum item cadastrado ainda.</td></tr>';
        return;
      }
      items.forEach(item => {
        const tr = document.createElement("tr");
        const tagsHtml = (item.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");
        const imagemHtml = item.imagemUrl 
          ? `<img src="${escapeAttr(item.imagemUrl)}" style="max-width:60px;border-radius:4px;" alt="Preview" />` 
          : "—";
        tr.innerHTML = `
          <td><strong>${escapeHtml(item.titulo)}</strong></td>
          <td>${escapeHtml(item.autor || "—")}</td>
          <td>${escapeHtml(item.tipoConteudo || "—")}</td>
          <td>${item.pago ? "✅ Sim" : "❌ Não"}</td>
          <td>${imagemHtml}</td>
          <td>${item.link ? `<a href="${escapeAttr(item.link)}" target="_blank">🔗 Abrir</a>` : "—"}</td>
          <td>${tagsHtml || "—"}</td>
          <td class="actions">
            <button data-act="edit" data-id="${item.id}">✏️ Editar</button>
            <button data-act="del" data-id="${item.id}">🗑️ Excluir</button>
          </td>
        `;
        body.appendChild(tr);
      });
      body.querySelectorAll("button[data-act='edit']").forEach(btn => {
        btn.addEventListener("click", () => onEdit(btn.dataset.id));
      });
      body.querySelectorAll("button[data-act='del']").forEach(btn => {
        btn.addEventListener("click", () => onDelete(btn.dataset.id));
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }));
    }
    function escapeAttr(s) {
      return String(s).replace(/"/g, "&quot;");
    }

    async function onEdit(id) {
      const res = await fetch(`/api/dict?id=${id}`);
      if (!res.ok) {
        setMsg("Erro ao carregar item para edição.", true);
        return;
      }
      const item = await res.json();
      $("#entryId").value = item.id;
      payloadToForm(item);
      setMsg("✏️ Editando item...");
      $("#titulo").focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function onDelete(id) {
      if (!confirm("⚠️ Tem certeza que deseja excluir este item?")) return;
      const res = await fetch(`/api/dict?id=${id}`, { method: "DELETE" });
      if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        setMsg("❌ Erro ao excluir: " + (e.error || res.statusText), true);
        return;
      }
      setMsg("✅ Item excluído com sucesso!");
      await loadList();
      resetForm();
    }

    async function onSubmit(e) {
      e.preventDefault();
      setMsg("");
      const id = $("#entryId").value;
      const payload = formToPayload();
      try {
        const url = id ? `/api/dict?id=${id}` : "/api/dict";
        const method = id ? "PUT" : "POST";
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
        setMsg(id ? "✅ Item atualizado com sucesso!" : "✅ Item criado com sucesso!");
        await loadList();
        resetForm();
      } catch (err) {
        setMsg("❌ " + String(err.message || err), true);
      }
    }

    function resetForm() {
      $("#entryId").value = "";
      selectedTags = [];
      clearImageUpload();
      payloadToForm({ titulo: "", autor: "", tipoConteudo: "", pago: false, link: "", imagemUrl: "", tags: [] });
    }

    $("#dictForm").addEventListener("submit", onSubmit);
    $("#resetBtn").addEventListener("click", () => { resetForm(); setMsg("🔄 Formulário limpo."); });

    // Inicializar
    loadCategorias();
    loadList();
  </script>
</body>
</html>
